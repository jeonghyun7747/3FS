# 3FS dev
## 3FS build dependencies 
### time date 
* timedatectl
```sh
$ timedatectl status               
$ sudo timedatectl set-ntp true
$ sudo systemctl restart systemd-timesyncd
$ timedatectl status
```
* ntpdate 
```sh
$ sudo apt install ntpdate -y
$ sudo ntpdate time.google.com
```
### Install dependencies:
```bash
# for Ubuntu 22.04.
$ sudo  apt install cmake libuv1-dev liblz4-dev liblzma-dev libdouble-conversion-dev libdwarf-dev libunwind-dev \
  libaio-dev libgflags-dev libgoogle-glog-dev libgtest-dev libgmock-dev clang-format-14 clang-14 clang-tidy-14 lld-14 \
  libgoogle-perftools-dev google-perftools libssl-dev gcc-12 g++-12 libboost-all-dev

$ sudo apt install -y meson ninja-build pkg-config libfuse3-dev
$ sudo apt install curl wget 
$ sudo apt install nvme-cli xfsprogs
$ sudo apt install python3-pip
```

### Rust 
#### sslVerify 
```sh
$ sudo apt install curl wget 
$ git config --global http.sslVerify false
$ git config --global --get http.sslVerify

$ cat ~/.wgetrc
check-certificate=off

$ cat ~/.curlrc
insecure

$ sudo apt update && sudo apt install --reinstall ca-certificates
```
#### Rust install 
```sh
$ curl --insecure --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
$ curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

* 수동설치 
$ wget --no-check-certificate https://sh.rustup.rs -O rustup.init.w.sh
$ sh ./rustup-init.sh 

$ curl --insecure https://sh.rustup.rs  -sSf > rustup.init.c.sh
```
```sh
$ . "$HOME/.cargo/env"   
$ rustup update
$ rustup --version
$ cargo --version
$ rustc --version
```

#### Rust 수동 설치 
```sh
$ curl -L https://github.com/rust-lang/rustup/archive/refs/tags/1.26.0.tar.gz -o rustup.tar.gz
```
* 직접설치
=> 잘 안되면 https를 http로 수정해서 진행한다.
```sh
$ curl -O https://sh.rustup.rs
$ sh rustup-init.sh --no-modify-path
$ source $HOME/.cargo/env

$ export RUSTUP_DIST_SERVER=http://static.rust-lang.org
$ export RUSTUP_UPDATE_ROOT=http://static.rust-lang.org/rustup

$ rustup default stable
$ rustup update
$ rustup --version
$ cargo --version
$ rustc --version
```

### FoundationDB
* download & install  
```sh
$ wget --no-check-certificate  https://github.com/apple/foundationdb/releases/download/7.1.67/foundationdb-clients_7.1.67-1_amd64.deb
$ wget --no-check-certificate  https://github.com/apple/foundationdb/releases/download/7.1.67/foundationdb-server_7.1.67-1_amd64.deb
$ sudo dpkg -i foundationdb-server_7.1.67-1_amd64.deb
$ sudo dpkg -i foundationdb-clients_7.1.67-1_amd64.deb
```
###  Fuse 3.16
```sh
$ wget --no-check-certificate https://github.com/libfuse/libfuse/releases/download/fuse-3.16.1/fuse-3.16.1.tar.gz
$ gunzip fuse-3.16.1.tar.gz
$ tar xvf  fuse-3.16.1.tar
$ sudo apt install -y meson ninja-build pkg-config libfuse3-dev
$ meson setup build
$ meson setup --wipe build   #<-- remove
$ meson setup --reconfigure  build  #<-- rebuild
$ cd build
$ ninja 
$ sudo ninja install 
$ fusermount3 --version 
$ lsmod  | grep fuse
$ sudo usermod -aG fuse $(whoami)
$ newgrp fuse
```
* fuse github
```sh
$ sudo apt update
$ sudo apt install -y meson ninja-build pkg-config libfuse3-dev
$ git clone https://github.com/libfuse/libfuse.git
$ cd libfuse
$ meson setup build
$ cd build
$ ninja
$ sudo ninja install
$ fusermount3 --version
$ lsmod | grep fuse
$ sudo usermod -aG fuse $(whoami)
$ newgrp fuse
```

## Check out source code

### git repository 
```sh
git@github.com:jeonghyun7747/3FS.git
https://github.com/jeonghyun7747/3FS.git
```
###  Clone 3FS repository from GitHub:
```sh
$ git clone https://github.com/deepseek-ai/3fs
```
When `deepseek-ai/3fs` has been cloned to a local file system, run the
following commands to check out the submodules:

```bash
$ cd 3fs
$ git submodule update --init --recursive
$ ./patches/apply.sh
```

## Build 3FS

* Build 3FS in `build` folder:
```sh
$ cmake -S . -B build -DCMAKE_CXX_COMPILER=clang++-14 -DCMAKE_C_COMPILER=clang-14 -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
$ cmake --build build -j 6  
$ cmake --build build -j 6  -v 2>&1 | tee build3.log
```

### cmake 디버깅 모드 동작 
```sh
$ cmake -S . -B build -DCMAKE_CXX_COMPILER=clang++-14 -DCMAKE_C_COMPILER=clang-14 -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_VERBOSE_MAKEFILE=ON
$ cmake --build build -j 16 -v 2>&1  | tee build_2.log

$ cmake --build build -j 16 -v -t hf3fs_common_shared
```
### 컴파일 결과 

```sh
jhyunlee@v70:~/3FS/build/bin$ ls -l
total 1548744
-rwxrwxr-x 1 jhyunlee jhyunlee 148480072 Jun  6 13:04 hf3fs-admin
-rwxrwxr-x 1 jhyunlee jhyunlee 209267656 Jun  6 13:11 hf3fs_fuse_main
-rwxrwxr-x 1 jhyunlee jhyunlee 284511104 Jun  6 13:11 meta_main
-rwxrwxr-x 1 jhyunlee jhyunlee 178916192 Jun  6 13:09 mgmtd_main
-rwxrwxr-x 1 jhyunlee jhyunlee 172360872 Jun  6 12:54 migration_main
-rwxrwxr-x 1 jhyunlee jhyunlee 105220160 Jun  6 12:35 monitor_collector_main
-rwxrwxr-x 1 jhyunlee jhyunlee 174745424 Jun  6 12:53 simple_example_main
-rwxrwxr-x 1 jhyunlee jhyunlee 312393136 Jun  6 13:03 storage_main
```


